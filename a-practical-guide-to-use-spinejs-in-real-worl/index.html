


<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"><![endif]-->
<!--[if IE 7]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if IE 8]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]<!-->
<html class="no-js" lang="zh">
  <!--<![endif]-->
  <head>
    <meta charset="UTF-8">

    <title>
        A Practical Guide to Use Spine.JS in Real World App
 - Pragmatic.ly Blog
    </title>

    <meta name="description" content="The voice of The Pragmatic.ly Team sharing Nes, Thoughts & Fun.">
    <meta name="keywords" content="  ["SpineJS", "JavaScript MVC", "JavaScript", "Spine"]
">
    <meta name="author" content="The Pragmatic.ly Team">

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="cleartype" content="on">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <link rel="apple-touch-icon-precomposed" type="image/png" sizes="57x57" href="/apple-touch-icon-57x57-precomposed.png">
    <link rel="apple-touch-icon-precomposed" type="image/png" sizes="72x72" href="/apple-touch-icon-72x72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" type="image/png" sizes="114x114" href="/apple-touch-icon-114x114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" type="image/png" href="/apple-touch-icon-precomposed.png">
    <link rel="apple-touch-icon" type="image/png" href="/apple-touch-icon.png">

    <link rel="icon" type="image/png" sizes="16x16" href="/favicon.png">
    <link rel="shortcut icon" sizes="16x16" href="/favicon.ico">
    <link rel="alternate" type="application/rss+xml" title="Fengche.co Blog Feed" href="/feed.xml" />
    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link href="/blog/stylesheets/application.css?1391017519" media="screen" rel="stylesheet" type="text/css" />
    <script src="/blog/javascripts/application.js?1391018543" type="text/javascript"></script>

    

    
    <!-- start Mixpanel -->
    <script type="text/javascript">(function(e,b){if(!b.__SV){var a,f,i,g;window.mixpanel=b;a=e.createElement("script");a.type="text/javascript";a.async=!0;a.src=("https:"===e.location.protocol?"https:":"http:")+'//cdn.mxpnl.com/libs/mixpanel-2.2.min.js';f=e.getElementsByTagName("script")[0];f.parentNode.insertBefore(a,f);b._i=[];b.init=function(a,e,d){function f(b,h){var a=h.split(".");2==a.length&&(b=b[a[0]],h=a[1]);b[h]=function(){b.push([h].concat(Array.prototype.slice.call(arguments,0)))}}var c=b;"undefined"!==
typeof d?c=b[d]=[]:d="mixpanel";c.people=c.people||[];c.toString=function(b){var a="mixpanel";"mixpanel"!==d&&(a+="."+d);b||(a+=" (stub)");return a};c.people.toString=function(){return c.toString(1)+".people (stub)"};i="disable track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config people.set people.set_once people.increment people.append people.track_charge people.clear_charges people.delete_user".split(" ");for(g=0;g<i.length;g++)f(c,i[g]);
b._i.push([a,e,d])};b.__SV=1.2}})(document,window.mixpanel||[]);
    mixpanel.init("43a596021773ee49e7b13713d89c9875");</script>
    <!-- end Mixpanel -->
    
  </head>

  <body class="a-practical-guide-to-use-spinejs-in-real-worl a-practical-guide-to-use-spinejs-in-real-worl_index">

    <header class="navbar navbar-fixed-top" role="banner">
      <div class="container">

        <a class="btn btn-navbar" data-target=".nav-collapse" data-toggle="collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </a>

        <a class="brand" href="https://fengche.co/" tabindex="-1">Fengche.co</a>

        <nav class="nav-collapse collapse" role="navigation">
        <ul class="nav pull-right">
          <li><a href="https://fengche.co">首页</a></li>
          <li><a href="https://fengche.co/tour">了解产品</a></li>
          <li><a href="https://fengche.co/pricing">价格方案</a></li>
          <li><a class="login" data-target="#login-modal" data-toggle="modal" href="https://fengche.co/login" role="button" type="button">登录</a></li>
          <li class="action"><a class="signup" href="https://fengche.co/signup">免费注册</a></li>
        </ul>
        </nav>

      </div>
    </header>

    <section class="hero wrap-blue">
      <div class="container header">
        
           <h1 class="blog-name">Fengche.co 官方博客</h1>
           <p>
            好好做产品，做好产品
           </p>
        
      </div>
    </section>

    <section class="main">
      <div class="container">
          <article class="post single">

    <header>
  <h2 class="title">
    <a href="/blog/a-practical-guide-to-use-spinejs-in-real-worl">A Practical Guide to Use Spine.JS in Real World App</a>
  </h2>
</header>

<aside>
  <ul class="meta">
    <li class="author-photo">
      <a href="http://yedingding.com">
        <img alt="" width="120" height="120" src="/blog/images/dingding-ye.png?1379005285" />
      </a>
    </li>
    <li class="author">
     by 叶玎玎
    </li>
    <li class="date">
      Aug 20, 2012
    </li>
    <li class="tags">
      
        <a href="/blog/tags/spinejs">SpineJS</a>
      
        <a href="/blog/tags/javascript-mvc">JavaScript MVC</a>
      
        <a href="/blog/tags/javascript">JavaScript</a>
      
        <a href="/blog/tags/spine">Spine</a>
      
    </li>
    <li class="back-link">
      <a href="/blog">&lsaquo; 返回博客主页</a>
    </li>
  </ul>
</aside>

<div class="content">
  <p>To give users the best possible fluid experience, we designed <a href="https://pragmatic.ly">Pragmatic.ly</a> and complied with the <a href="http://en.wikipedia.org/wiki/Single-page_application">single page application</a> standard. We believe that could make users focus on building product rather than spending time on project management itself. A wide range of technology solutions are available to make a single page application. Current trends suggest moving core application from server to client side and keeping server load at minimum for better performance by pure data APIs. <a href="https://pragmatic.ly">Pragmatic.ly</a> took on the challange to cater to this need by developing server side in Rails, Spine.js at client side.</p>

<h3>Why Spine.JS</h3>

<p>There are many different JavaScript MVC frameworks such as <a href="http://backbonejs.org/">Backbone.js</a>, <a href="http://spinejs.com/">Spine.js</a>, <a href="http://knockoutjs.com/">Knockout.js</a>, <a href="http://emberjs.com/">Ember.js</a>, etc. There are too many choices and when I started Pragmatic.ly, I was struggling with the problem of which one I should pick up. Instead of wasting time on choosing I did a quick review by comparing the documents and then decided to choose Spine.js to start with. With months of development so far, I&#39;m glad that Spine.js works pretty well and below are the great benefits I have found in using Spine.js.</p>

<ul>
<li><em>Simple and lightweight</em>. It&#39;s easy to dive into the core and extend as you need to.</li>
<li><em>MVC pattern at its core</em>. It&#39;s very similar to the Rails counterparts. So I&#39;m very comfortable with it from the first day.</li>
<li><em>Rails integration</em>. It can&#39;t be easier to use Rails as the backend data API in Spine.js app. And the <a href="https://github.com/maccman/spine-rails">spine-rails</a> gem is another great addition.</li>
<li><a href="http://alexmaccaw.com/posts/async_ui"><em>Asynchronous UI</em></a>. Ideally UIs never block and it will automatically update the data in backend. This brings the fast and very responsive user interface.</li>
</ul>

<p>If you want to get a brief review among different frameworks, check out <a href="http://codebrief.com/2012/01/the-top-10-javascript-mvc-frameworks-reviewed/">this article</a> written by Gordon L. Hemption.</p>

<h3>How we use Spine.js in Pragmatic.ly</h3>

<p>We use spine-rails to generate the Spine.app structure, very similar to Rails app structure.</p>
<div class="highlight"><pre>├── app
│   ├── controllers
│   │   ├── center
│   │   │   ├── filter_controller.js.coffee
│   │   │   └── tickets_controller.js.coffee
│   │   ├── center_content_controller.coffee
│   │   ├── comments_controller.js.coffee
│   │   ├── header
│   │   │   └── project_nav_controller.js.coffee
│   │   ├── header_controller.coffee
│   │   ├── iterations_controller.coffee
│   │   ├── left_sidebar_controller.coffee
│   │   ├── projects_controller.coffee
│   │   ├── right_sidebar_controller.coffee
│   │   ├── sidebars
│   │   │   ├── left_iteration.js.coffee
│   │   │   ├── left_people.js.coffee
│   │   │   ├── right_activities.js.coffee
│   │   │   └── right_detail_section.js.coffee
│   │   ├── tickets_controller.coffee
│   │   └── users_controller.js.coffee
│   ├── index.js.coffee
│   ├── lib
│   │   ├── constants.js.coffee
│   │   ├── eco-helpers.js
│   │   └── view.js.coffee
│   ├── models
│   │   ├── comment.js.coffee
│   │   ├── iteration.js.coffee
│   │   ├── project.js.coffee
│   │   ├── ticket.js.coffee
│   │   └── user.js.coffee
│   └── views
│       ├── comments
│       │   ├── audit.jst.eco
│       │   ├── form.jst.eco
│       │   └── plain.jst.eco
│       ├── iterations
│       │   ├── section.jst.eco
│       │   └── show.jst.eco
│       ├── projects
│       │   ├── edit.jst.eco
│       │   ├── form.jst.eco
│       │   ├── new.jst.eco
│       │   └── switch.jst.eco
│       ├── tickets
│       │   ├── section.jst.eco
│       │   ├── show.jst.eco
│       │   └── toolbar.jst.eco
│       └── users
│           ├── people.jst.eco
│           └── show.jst.eco
├── application.js
├── bootstrap.js.coffee
└── dashboard.js.coffee
</pre></div>
<p>So basically it&#39;s controllers, models and views.</p>

<h3>Controllers</h3>

<p>There are two kinds of Controllers in Pragmatic.ly. In Spine, Controllers are considered the glue of an application, adding and responding to DOM events, rendering templates and ensuring that views and models are kept in sync. For example,</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">LeftIterationController</span> <span class="k">extends</span> <span class="nx">Spine</span><span class="p">.</span><span class="nx">Controller</span>
  <span class="nv">el: </span><span class="s">&#39;.sidebar #iterations&#39;</span>

  <span class="nv">elements:</span>
    <span class="s">&#39;ul.list&#39;</span><span class="o">:</span> <span class="s">&#39;list&#39;</span>

  <span class="nv">constructor: </span><span class="nf">-&gt;</span>
    <span class="k">super</span>
    <span class="nx">App</span><span class="p">.</span><span class="nx">Iteration</span><span class="p">.</span><span class="nx">bind</span> <span class="s">&#39;create&#39;</span><span class="p">,</span> <span class="nx">@addIteration</span>
    <span class="nx">App</span><span class="p">.</span><span class="nx">Iteration</span><span class="p">.</span><span class="nx">bind</span> <span class="s">&#39;refresh&#39;</span><span class="p">,</span> <span class="nx">@refreshIterations</span>

  <span class="nv">release: </span><span class="nf">-&gt;</span>
    <span class="k">super</span>
    <span class="nx">App</span><span class="p">.</span><span class="nx">Iteration</span><span class="p">.</span><span class="nx">unbind</span> <span class="s">&#39;create&#39;</span><span class="p">,</span> <span class="nx">@addIteration</span>
    <span class="nx">App</span><span class="p">.</span><span class="nx">Iteration</span><span class="p">.</span><span class="nx">unbind</span> <span class="s">&#39;refresh&#39;</span><span class="p">,</span> <span class="nx">@refreshIterations</span>

  <span class="nv">addIteration: </span><span class="nf">(iteration) =&gt;</span>
    <span class="nx">iteration</span><span class="p">.</span><span class="nx">unbind</span><span class="p">()</span>
    <span class="nv">view = </span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">IterationItem</span><span class="p">(</span><span class="nv">item: </span><span class="nx">iteration</span><span class="p">)</span>
    <span class="nx">@list</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span><span class="p">)</span>

  <span class="nv">refreshIterations: </span><span class="nf">(iterations) =&gt;</span>
    <span class="nx">@addIteration</span> <span class="nx">iteration</span> <span class="k">for</span> <span class="nx">iteration</span> <span class="k">in</span> <span class="nx">iterations</span>
</pre></div>
<p>We split the page into multiple blocks and each block is a Spine Controller. Talking the above example, LeftIterationsController is the Controller to manage the iterations list in the left sidebar.</p>

<p>Then what&#39;s the other kind? The answer is Routes! We extract the routes to the dedicated controllers now. It will setup the routes and respond to the navigation event. Then it will prepare the data and trigger the event to let another controller handle it to render templates. For example,</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">TicketsController</span> <span class="k">extends</span> <span class="nx">Spine</span><span class="p">.</span><span class="nx">Controller</span>
  <span class="nv">constructor: </span><span class="nf">-&gt;</span>
    <span class="k">super</span>
    <span class="nx">@routes</span>
      <span class="s">&quot;/tickets&quot;</span><span class="o">:</span> <span class="nx">@index</span>
      <span class="s">&quot;/tickets/:id&quot;</span> <span class="o">:</span> <span class="nf">(params) -&gt;</span>
        <span class="nx">@show</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>

  <span class="nv">index: </span><span class="nf">-&gt;</span>
    <span class="nv">tickets = </span><span class="nx">App</span><span class="p">.</span><span class="nx">Ticket</span><span class="p">.</span><span class="nx">all</span><span class="p">()</span>
    <span class="nx">App</span><span class="p">.</span><span class="nx">Ticket</span><span class="p">.</span><span class="nx">trigger</span> <span class="s">&quot;tickets:index&quot;</span><span class="p">,</span> <span class="nx">tickets</span>

  <span class="nv">show: </span><span class="nf">(id) -&gt;</span>
    <span class="nv">ticket = </span><span class="nx">App</span><span class="p">.</span><span class="nx">Ticket</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">publish</span> <span class="s">&#39;ticket:switch&#39;</span><span class="p">,</span> <span class="nx">ticket</span>
</pre></div>
<h3>Models</h3>

<p>Models manage data for the application. It&#39;s very similar to Rails models. I just want to mention one thing though - as we moved the logic from server side to client side, there was no need to translate 1:1 on the client side. Instead, encapsulate the data into model which is suitable for the page based on the user.</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Project</span> <span class="k">extends</span> <span class="nx">Spine</span><span class="p">.</span><span class="nx">Model</span>
  <span class="nx">@configure</span> <span class="s">&#39;Project&#39;</span><span class="p">,</span> <span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;description&#39;</span><span class="p">,</span> <span class="s">&#39;owner_id&#39;</span><span class="p">,</span> <span class="s">&#39;uid&#39;</span>
  <span class="nx">@extend</span> <span class="nx">Spine</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">Ajax</span>
  <span class="nx">@extend</span> <span class="nx">Spine</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">Dirty</span>

  <span class="nv">validate: </span><span class="nf">-&gt;</span>
    <span class="s">&#39;name required&#39;</span> <span class="k">unless</span> <span class="nx">@name</span>

  <span class="nv">inviteUser: </span><span class="nf">(email) -&gt;</span>
    <span class="nx">App</span><span class="p">.</span><span class="nx">Invitation</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nv">project_id: </span><span class="nx">@id</span><span class="p">,</span> <span class="nv">email: </span><span class="nx">email</span><span class="p">)</span>
</pre></div>
<h3>Views</h3>

<p>Views are about building and maintaining the DOM elements. Views in Spine are very simple and don&#39;t have the built-in UI binding. So most of the time you should let Controller observe the Model and get notified when the model changes, then update the view accordingly.</p>

<p>By doing all the view rendering client-side, you should use JavaScript templating solution to define templates for views as markup containing tempalte variables. There are a number of good candidates, such as Mustache, jQuery.tmpl and Eco.</p>

<p>I use Eco in Pragmatic.ly. The Erb-like syntax and CoffeeScript support is a big triumph. However, you should know that every eco template generates the same helpers which will increase the file size. You can use this <a href="https://gist.github.com/sishen/2360781">gist</a> to avoid the problem which will register the global helpers and inject into the Eco templates.</p>
<div class="highlight"><pre><span class="c1"># Put this file in lib/</span>

<span class="nb">require</span> <span class="s1">&#39;sprockets/eco_template&#39;</span>

<span class="k">class</span> <span class="nc">CleanEcoTemplate</span> <span class="o">&lt;</span> <span class="ss">Sprockets</span><span class="p">:</span><span class="ss">:EcoTemplate</span>
  <span class="no">FROM</span> <span class="o">=</span> <span class="s2">&quot;  (function() {&quot;</span>
  <span class="no">TO</span> <span class="o">=</span> <span class="s2">&quot;}).call(__obj);&quot;</span>

  <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">locals</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="no">Eco</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">from</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="no">FROM</span><span class="p">)</span>
    <span class="n">to</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">rindex</span><span class="p">(</span><span class="no">TO</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">[</span><span class="n">from</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">to</span><span class="o">]</span> <span class="o">+</span> <span class="no">TO</span>
    <span class="o">&lt;&lt;-</span><span class="no">JS</span>
<span class="sh">function(__obj) {</span>
<span class="sh">  if (!__obj) __obj = {};</span>
<span class="sh">  var __helpers = window.ecoHelpers;</span>
<span class="sh">  var __out = [];</span>
<span class="sh">  var __sanitize = __helpers.sanitize;</span>
<span class="sh">  var __capture = __helpers.captureFor(__obj, __out);</span>
<span class="sh">  var __rememberSafe = __obj.safe;</span>
<span class="sh">  var __rememberEscape = __obj.escape;</span>
<span class="sh">  __obj.safe = __helpers.safe;</span>
<span class="sh">  __obj.escape = __helpers.escape;</span>
<span class="sh">#{content}</span>
<span class="sh">  __obj.safe = __rememberSafe;</span>
<span class="sh">  __obj.escape = __rememberEscape;</span>
<span class="sh">  return __out.join(&#39;&#39;);</span>
<span class="sh">};</span>
<span class="no">      JS</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div><div class="highlight"><pre><span class="c1"># Put this file in config/initializers</span>

<span class="nb">require</span> <span class="s1">&#39;clean_eco_template&#39;</span>

<span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">register_engine</span> <span class="s1">&#39;.eco&#39;</span><span class="p">,</span> <span class="no">CleanEcoTemplate</span>
</pre></div><div class="highlight"><pre><span class="err">#</span> <span class="nx">Must</span> <span class="nx">include</span> <span class="nx">eco</span><span class="o">-</span><span class="nx">helpers</span><span class="p">.</span><span class="nx">js</span> <span class="nx">before</span> <span class="nx">eco</span> <span class="nx">files</span>

<span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">global</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">ecoHelpers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">sanitize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">ecoSafe</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">ecoHelpers</span><span class="p">.</span><span class="nx">escape</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">},</span>

    <span class="nx">safe</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">ecoSafe</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">))</span> <span class="nx">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">String</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
        <span class="nx">result</span><span class="p">.</span><span class="nx">ecoSafe</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">},</span>

    <span class="nx">escape</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;&#39;</span> <span class="o">+</span> <span class="nx">value</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&amp;/g</span><span class="p">,</span> <span class="s1">&#39;&amp;amp;&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;/g</span><span class="p">,</span> <span class="s1">&#39;&amp;lt;&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&gt;/g</span><span class="p">,</span> <span class="s1">&#39;&amp;gt;&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&quot;/g</span><span class="p">,</span> <span class="s1">&#39;&amp;quot;&#39;</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">captureFor</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">out</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">out</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
        <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">ecoHelpers</span><span class="p">.</span><span class="nx">safe</span><span class="p">(</span><span class="nx">out</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">length</span><span class="p">,</span> <span class="nx">out</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">length</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">));</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="nx">global</span><span class="p">.</span><span class="nx">ecoHelpers</span> <span class="o">=</span> <span class="nx">ecoHelpers</span><span class="p">;</span>
<span class="p">})(</span><span class="nb">window</span><span class="p">);</span>
</pre></div>
<h3>Problems</h3>

<p>So that&#39;s how we use Spine.js to power Pragmatic.ly. It works very well but still have some limitations.</p>

<ul>
<li><p>By default, you can only monitor the whole Model change event and update the view accordingly. For example, even the username is not changed, you still have to update the views containing that data. There is a &ldquo;change:field&rdquo; event in Backbone.js which allow you only to update the view when that field of data changed. I like that. So I made a plugin to support that. Check the Gist out.</p>
<div class="highlight"><pre><span class="nx">Spine</span> <span class="o">?=</span> <span class="nx">require</span><span class="p">(</span><span class="s">&#39;spine&#39;</span><span class="p">)</span>

<span class="nv">Include =</span>
  <span class="nv">savePrevious: </span><span class="nf">-&gt;</span>
  <span class="nx">@constructor</span><span class="p">.</span><span class="nx">records</span><span class="p">[</span><span class="nx">@id</span><span class="p">].</span><span class="nv">previousAttributes = </span><span class="nx">@attributes</span><span class="p">()</span>

<span class="nv">Spine.Model.Dirty =</span>
  <span class="nv">extended: </span><span class="nf">-&gt;</span>
    <span class="nx">@bind</span> <span class="s">&#39;refresh&#39;</span><span class="p">,</span> <span class="nf">-&gt;</span>
    <span class="nx">@each</span> <span class="nf">(record) -&gt;</span> <span class="nx">record</span><span class="p">.</span><span class="nx">savePrevious</span><span class="p">()</span>

    <span class="nx">@bind</span> <span class="s">&#39;save&#39;</span><span class="p">,</span> <span class="nf">(record) -&gt;</span>
      <span class="k">if</span> <span class="nx">record</span><span class="p">.</span><span class="nx">previousAttributes</span><span class="o">?</span>
        <span class="k">for</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">record</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">attributes</span> <span class="k">when</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">record</span>
          <span class="k">if</span> <span class="nx">record</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">isnt</span> <span class="nx">record</span><span class="p">.</span><span class="nx">previousAttributes</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
            <span class="nx">record</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s">&#39;change:&#39;</span><span class="o">+</span><span class="nx">key</span><span class="p">,</span> <span class="nx">record</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span>
      <span class="nx">record</span><span class="p">.</span><span class="nx">savePrevious</span><span class="p">()</span>

    <span class="nx">@include</span> <span class="nx">Include</span>
</pre></div>
<p>So the model object can bind the event &ldquo;change:#{field} to trigger event when the field value is changed.</p>

<p>By default it&#39;s off and if need this feature, the model should extend Spine.Model.Dirty.</p>

<p>A sample case.</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nx">User</span> <span class="k">extends</span> <span class="nx">Spine</span><span class="p">.</span><span class="nx">Model</span>
  <span class="nx">@extend</span> <span class="nx">Spine</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">Dirty</span>
<span class="nx">end</span>
</pre></div></li>
<li><p>The Ajax plugin in Spine.js plays very nice with backend REST APIs, such as Rails. For example, creating the model will trigger a &quot;CREATE /collections&rdquo; event to the server and updating the model will trigger a &ldquo;PUT /collections/id&rdquo; event, seemlessly. However, nested resources in Rails is very common but Spine lacks to support that. Either you have to trigger requests to top-level URL or setup the request yourself. I have done a dirty hack to support scoping. It&#39;s dirty but works.</p>
<div class="highlight"><pre> <span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Ticket</span> <span class="k">extends</span> <span class="nx">Spine</span><span class="p">.</span><span class="nx">Model</span>
  <span class="nx">@configure</span> <span class="s">&#39;Ticket&#39;</span><span class="p">,</span> <span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="s">&quot;project_id&quot;</span>

  <span class="vi">@scope: </span><span class="nf">-&gt;</span>
    <span class="s">&quot;projects/</span><span class="si">#{</span><span class="nx">current</span><span class="p">.</span><span class="nx">project_id</span><span class="si">}</span><span class="s">&quot;</span>

  <span class="nv">scope: </span><span class="nf">-&gt;</span>
    <span class="s">&quot;projects/</span><span class="si">#{</span><span class="nx">@project_id</span><span class="si">}</span><span class="s">&quot;</span>
</pre></div></li>
<li><p>Asynchronous UI is cool and works for 98% situations. But in a real world app you have to deal with errors like bugs or network failures. Spine doesn&#39;t have the default error handling for this situation and leave all work to you. It&#39;s fine but you should know that for that 2% situation, you have to spend lots of time to avoid the impact.</p></li>
</ul>

<h3>Test</h3>

<p>I would like to cover how Test works in Pragmatic.ly in another post. To give a quick overview, we use <a href="http://pivotal.github.com/jasmine/">Jasmine</a> for JS test and <a href="http://siliconforks.com/jscoverage/">JSCoverage</a> for measuring code coverage. Nice pair!</p>

<p><br/></p>

<h3>About Pragmatic.ly</h3>

<p><a href="https://pragmatic.ly">Pragmatic.ly</a> is a lean collaborative project management tool aiming to help small teams make better products easier. It&#39;s the ideal and elegant project management tool for tech startups.</p>

<p>Now that you&#39;ve read so far, you should follow me <a href="https://twitter.com/yedingding">@yedingding</a>!</p>

</div>


  </article>

  <div id="disqus_thread"></div>
  <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'pragmaticlyblog'; // required: replace example with your forum shortname
    var disqus_identifier = 'a-practical-guide-to-use-spine-js-in-real-world-app';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>

  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


      </div>
    </section>

    <footer class="site-footer" role="contentinfo">
      <div class="container">
        <div class="row">
          <div class="span2 offset2">
            <nav>
            <h5>网站相关</h5>
            <ul>
              <li><a href="https://fengche.co/">首页</a></li>
              <li><a href="https://fengche.co/tour">了解产品</a></li>
              <li><a href="https://fengche.co/pricing">价格方案</a></li>
              <li><a href="https://fengche.co/privacy">隐私政策</a></li>
              <li><a href="https://fengche.co/terms">服务条款</a></li>
            </ul>
            </nav>
          </div>

          <div class="span2">
            <nav>
              <h5>服务支持</h5>
              <ul>
                <!--<li><a href="/help">帮助中心</a></li>-->
                <li><a href="https://fengche.co/get-started">新手帮助</a></li>
                <li><a href="mailto:support@fengche.co">联系我们</a></li>
              </ul>
            </nav>
          </div>

          <div class="span2">
            <nav>
              <h5>联系合作</h5>
              <ul>
                <li><a href="https://fengche.co/about">关于我们</a></li>
                <li><a href="mailto:press@fengche.co">合作伙伴</a></li>
                <li><a href="mailto:press@fengche.co">媒体报道</a></li>
              </ul>
            </nav>
          </div>

          <div class="span2">
            <nav>
              <h5>关注我们</h5>
              <ul>
                <li><a href="https://fengche.co/blog">官方博客</a></li>
                <li><a class="social-weibo" href="http://weibo.com/fengcheco" target="_blank">微博</a></li>
                <li><a class="social-facebook" href="https://facebook.com/fengcheco" target="_blank">Facebook</a></li>
                <li><a class="social-twitter" href="https://twitter.com/#!/fengcheco" target="_blank">Twitter</a></li>
                <li><a class="social-google" href="https://plus.google.com/109049203627299997967">Google+</a></li>
              </ul>
            </nav>
          </div>
        </div>

        <div class="copyright">
          <p>&copy; 2012-2014 Fengche.co</p>
        </div>
      </div>
    </footer>

    <!-- begin olark code -->
    <script data-cfasync="false" type='text/javascript'>/*{literal}<![CDATA[*/
      window.olark||(function(c){var f=window,d=document,l=f.location.protocol=="https:"?"https:":"http:",z=c.name,r="load";var nt=function(){f[z]=function(){(a.s=a.s||[]).push(arguments)};var a=f[z]._={},q=c.methods.length;while(q--){(function(n){f[z][n]=function(){f[z]("call",n,arguments)}})(c.methods[q])}a.l=c.loader;a.i=nt;a.p={0:+new Date};a.P=function(u){a.p[u]=new Date-a.p[0]};function s(){a.P(r);f[z](r)}f.addEventListener?f.addEventListener(r,s,false):f.attachEvent("on"+r,s);var ld=function(){function p(hd){hd="head";return["<",hd,"></",hd,"><",i,' onl' + 'oad="var d=',g,";d.getElementsByTagName('head')[0].",j,"(d.",h,"('script')).",k,"='",l,"//",a.l,"'",'"',"></",i,">"].join("")}var i="body",m=d[i];if(!m){return setTimeout(ld,100)}a.P(1);var j="appendChild",h="createElement",k="src",n=d[h]("div"),v=n[j](d[h](z)),b=d[h]("iframe"),g="document",e="domain",o;n.style.display="none";m.insertBefore(n,m.firstChild).id=z;b.frameBorder="0";b.id=z+"-loader";if(/MSIE[ ]+6/.test(navigator.userAgent)){b.src="javascript:false"}b.allowTransparency="true";v[j](b);try{b.contentWindow[g].open()}catch(w){c[e]=d[e];o="javascript:var d="+g+".open();d.domain='"+d.domain+"';";b[k]=o+"void(0);"}try{var t=b.contentWindow[g];t.write(p());t.close()}catch(x){b[k]=o+'d.write("'+p().replace(/"/g,String.fromCharCode(92)+'"')+'");d.close();'}a.P(2)};ld()};nt()})({loader: "static.olark.com/jsclient/loader0.js",name:"olark",methods:["configure","extend","declare","identify"]});
/* custom configuration goes here (www.olark.com/documentation) */
olark.identify('8594-504-10-6122');/*]]>{/literal}*/
    </script>
    <noscript><a
      href="https://www.olark.com/site/8594-504-10-6122/contact"
      title="Contact us" target="_blank">Questions? Feedback?</a>
      powered by <a href="http://www.olark.com?welcome" title="Olark
      live chat software">Olark live chat software</a></noscript>
      <!-- end olark code -->
  </body>
</html>
